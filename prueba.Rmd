---
title: "Ficha de Información Metropolitana"
author: "Martínez Rodriguez, Alvaro; Pérez Victorino, Leonardo"
institution: "Universidad Autonóma Metropolitana Unidad Azcapotzalco"
date: "4 de abril de 2023"
output: 
  html_document:
    theme: cerulean
params:
  zona: "1.01"
---

```{r message=FALSE, warning=FALSE, include=FALSE}

library(readxl)
Base_unica <- read_excel("Bases de datos\\Base única.xlsx")

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Obtener el nombre de todas las variables en la base de datos
variables <- names(Base_unica)

# Filtrar las variables que deseas utilizar
variables_utilizar <- variables[variables != "ID_VIV"]

# Utilizar las variables filtradas en tus cálculos o análisis
Base_zona <- Base_unica[Base_unica$CVE_ZM == params$zona, variables_utilizar]

```
<div style="text-align: justify"> <div/>\ 

La ficha de información metropolitana es un recurso valioso para la planificación territorial en zonas metropolitanas. En ella se incluyen datos censales en diversos formatos, como gráficas, tablas y mapas provenientes principalmente de los censos económicos de los años 1999, 2004, 2009, 2014 y 2019. A su vez, también incluye información de los censos de población y vivienda del año 2020, ambos censos son publicados por el Instituto Nacional de Estadística y Geografía (INEGI).\ 

# Ficha básica de la Zona Metropolitana de ``r unique(Base_zona$NOM_ZM) ``
Según INEGI, las zonas metropolitanas son aquellas áreas urbanas que se componen de una ciudad principal (núcleo urbano) y su zona conurbada. Estas áreas urbanas se caracterizan por tener una alta densidad de población y estar interconectadas por vías de transporte y comunicación.La zona metropolitana de ``r unique(Base_zona$NOM_ZM) ``, se localiza en ``r unique(Base_zona$nom_ent) ``. La zona se compone de un total de ``r nrow(Base_zona[Base_zona$CVE_ZM == params$zona, "cv_mun", drop = FALSE]) `` municipios, los cuales son:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.cap= "Municipios de la zona metropolitana", fig.width=4, fig.height=4}

library(knitr)
library(kableExtra)
library(DT)
library(data.table)
library(scales)
Base_zona_subset <- subset(Base_zona, select = c(nom_mun, cvegeo))

# Cambiar nombres de columnas
setnames(Base_zona_subset, c("Nombre", "Clave"))
datatable(Base_zona_subset, 
          caption = "Municipios",
          options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
          rownames = FALSE,
          width = "40%")

```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=4, fig.height=4, fig.cap= "Mapa de la zona metropolitana"}
#Mapa de la zona metropolitana

knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(sf)
library(ggplot2)
library(tmap)
library(tmaptools)
library(RColorBrewer)
library(cartogram)
# Carga los datos del archivo shapefile
municipios <- st_read("Bases de datos/cartografía/00mun.shp", quiet = TRUE)

# Filtra los municipios de la zona metropolitana seleccionada
municipios_zm <- municipios %>% filter(CVE_ZM == params$zona)

# Activa el modo dinámico de tmap
tmap_mode("view")

#mapa 2
tmap::tm_shape(municipios_zm) +
  tmap::tm_borders() +
  tmap::tm_fill("nom_ent", alpha = 0.9, legend.show = FALSE) +
  tmap::tm_basemap(providers$OpenStreetMap, alpha = 0.5)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Calcula el área en unidades del objeto sf
area <- st_area(municipios_zm)

# Convierte el área a kilómetros cuadrados
area_km2 <- area / 1000000
```

A continuación se presentan algunos datos generales sobre esta zona:

- ZM:``r unique(Base_zona$NOM_ZM) ``
- Número de municipios: ``r nrow(Base_zona[Base_zona$CVE_ZM == params$zona, "cv_mun", drop = FALSE]) ``
- Población total: ``r format(sum(Base_zona$POBTOT), big.mark=",") ``
- Superficie de la ZM: ``r sum(round(area_km2, 2)) ``
- Densidad poblacional: ``r round(sum(Base_zona$POBTOT)/sum(round(area_km2, 2)),digits= 3)`` Hab/Km^2.
- Grado promedio de escolaridad: ``r sum(Base_zona$GRAPROES)/nrow(Base_zona)``
- Población urbana:
- Pobalción rural:


### Estructura de la población.

La Estructura de Población de la zona metropolitana de ``r unique(Base_zona$NOM_ZM) `` presenta la siguiente forma:

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=5, fig.height=4}
#Piramide poblacional

library(ggplot2)
library(dplyr)
library(reshape2)
require(RColorBrewer)

# Sumar todos los registros para cada variable
total_poblacion <- c(
  sum(Base_zona$P_0A4_M), sum(Base_zona$P_5A9_M), sum(Base_zona$P_10A14_M),
  sum(Base_zona$P_15A19_M), sum(Base_zona$P_20A24_M), sum(Base_zona$P_25A29_M),
  sum(Base_zona$P_30A34_M), sum(Base_zona$P_35A39_M), sum(Base_zona$P_40A44_M),
  sum(Base_zona$P_45A49_M), sum(Base_zona$P_50A54_M), sum(Base_zona$P_55A59_M),
  sum(Base_zona$P_60A64_M), sum(Base_zona$P_65A69_M), sum(Base_zona$P_70A74_M),
  sum(Base_zona$P_75A79_M), sum(Base_zona$P_80A84_M), sum(Base_zona$P_85YMAS_M),
  sum(Base_zona$P_0A4_F), sum(Base_zona$P_5A9_F), sum(Base_zona$P_10A14_F),
  sum(Base_zona$P_15A19_F), sum(Base_zona$P_20A24_F), sum(Base_zona$P_25A29_F),
  sum(Base_zona$P_30A34_F), sum(Base_zona$P_35A39_F), sum(Base_zona$P_40A44_F),
  sum(Base_zona$P_45A49_F), sum(Base_zona$P_50A54_F), sum(Base_zona$P_55A59_F),
  sum(Base_zona$P_60A64_F), sum(Base_zona$P_65A69_F), sum(Base_zona$P_70A74_F),
  sum(Base_zona$P_75A79_F), sum(Base_zona$P_80A84_F), sum(Base_zona$P_85YMAS_F)
)
# Crear una tabla con la información separada por edad, sexo y población
# Crear una tabla con la información separada por edad, sexo y población
edades <- c(
  "0 a 4", "5 a 9", "10 a 14",
  "15 a 19", "20 a 24", "25 a 29",
  "30 a 34", "35 a 39", "40 a 44",
  "45 a 49", "50 a 54", "55 a 59",
  "60 a 64", "65 a 69", "70 a 74",
  "75 a 79", "80 a 84", "85 y más")

# Crear un vector con la información de género
generos <- rep(c("M", "F"), each = 18)

# Crear un vector con la información de población
poblacion <- c(total_poblacion[1:18], total_poblacion[19:36])

# Crear un data frame con la información
tabla_poblacion <- data.frame(edad = edades, genero = generos, poblacion = poblacion)

tabla_poblacion$poblacion<- ifelse(tabla_poblacion$genero == "M", -1*tabla_poblacion$poblacion, tabla_poblacion$poblacion)

tabla_poblacion$edad <- factor(tabla_poblacion$edad, levels = unique(tabla_poblacion$edad))

## Los gráficos piramidales son dos gráficos de barras con ejes invertidos
piramide <- ggplot(tabla_poblacion, aes(x = edad, y = poblacion), ) +
  geom_bar(data = subset(tabla_poblacion, genero == "F"), aes(fill = "F"), stat = "identity") +
  geom_bar(data = subset(tabla_poblacion, genero == "M"), aes(fill = "M"), stat = "identity") +
  scale_fill_manual(values=c("F"="#bc4ed8","M"="#1b004b")) +
  scale_y_continuous(labels = paste0(as.character(c(seq(2, 0, -1), seq(1, 2, 1))), "m"))  +
  coord_flip()+
  labs(fill = "Sexo", x = "Edad", y = "Población") +
  ggtitle("Gráfico Piramidal de Población")

piramide

```

:Fuente: Elaboración propia con datos de CPV (2020)


La población esta distribuida de la siguiente forma: 

```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE, fig.width=4, fig.height=4, fig.cap= "Distribución poblacional"}
# Seleccionar las variables de interés y unirlas con la cartografía por la clave cvegeo
municipios_unidos <- municipios_zm %>%
  inner_join(Base_zona %>% select(cvegeo, POBTOT, POBFEM, POBMAS), by = "cvegeo")

tmap_mode("view")
# Definir el número de clases en el mapa temático
if (nrow(municipios_unidos) < 5) {
  num_classes <- nrow(municipios_unidos)
} else {
  num_classes <- 5
}

# Crear el mapa temático
tmap::tm_shape(municipios_unidos) +
  tmap::tm_borders() +
  tmap::tm_fill("POBTOT", alpha = 0.9, title = "Población", style ="equal", n = num_classes) +
  tmap::tm_basemap(providers$OpenStreetMap, alpha = 0.5)
```

:Fuente: Elaboración propia con datos de CPV (2020)

#### Grupos de pobalción

- Población total respecto al país: ``r round(sum(Base_zona$POBTOT) / sum(Base_unica$POBTOT), digits = 3) %>% percent()``
- Población Masculina:  ``r round(sum(Base_zona$POBMAS) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
- Población Femenina: ``r round(sum(Base_zona$POBFEM) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
- Relación M-F: ``r round(sum(Base_zona$REL_H_M)/nrow(Base_zona),digits= 3) ``


```{r eval=FALSE, fig.height=4, fig.width=4, message=FALSE, warning=FALSE, include=FALSE}

# Agregar un cero a la izquierda de la variable cvegeo

Base_zona$cvegeo <- sprintf("%05d", Base_zona$cvegeo)
```

#### Vivienda

En el censo de Población y Vivienda del año 2020 los principales resultados para las viviendas son los siguientes:

- Número de viviendas habitadas: ``r format(sum(Base_zona$TVIVHAB), scientific = FALSE, digits = 3) ``
- Porcentaje de viviendas desocupadas:``r round(sum(Base_zona$VIVPAR_DES) / sum(Base_zona$VIVTOT), digits = 3) %>% percent()``
- Promedio de ocupantes por vivienda: ``r round (sum(Base_zona$PROM_OCUP)/nrow(Base_zona), digits = 3)``
- Promedio de ocupantes por cuarto:``r sum(Base_zona$PRO_OCUP_C)/nrow(Base_zona)``
- Porcentaje de viviendas con servicios básicos:``r round(sum(Base_zona$VPH_C_SERV) / sum(Base_zona$TVIVHAB), digits = 3) %>% percent()``
- Porcentaje de viviendas sin bienes2: ``r round(sum(Base_zona$VPH_SNBIEN) / sum(Base_zona$TVIVHAB), digits = 3) %>% percent()``
- Porcentaje de ocupantes en viviendas particulares que disponen de energía eléctrica, agua entubada y drenaje: ``r round(sum(Base_zona$VPH_SNBIEN) / sum(Base_zona$TVIVHAB), digits = 3) %>% percent()``

#### Socioeconómicos

Los datos del Censo de Población y Vivienda 2020 presentan los siguientes datos para caracterizar la población desde el punto de vista de su actividad económica:

- Porcentaje de población de 12 años y más económicamente activa: ``r round(sum(Base_zona$PEA) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
- Porcentaje de población de 12 años y más no económicamente activa: ``r round(sum(Base_zona$PE_INAC) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
` 

#### Educación

Según los datos del Censo de Población y Vivienda 2020, la educación de la zona metropolitana se caracteriza por los siguientes estadísticos:

- Porcentaje de población de 15 años y más sin escolaridad:``r round(sum(Base_zona$P15YM_SE) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
- Porcentaje de población de 15 años y más con al menos un grado aprobado en primaria: ``r round(1-(sum(Base_zona$PE_INAC) / sum(Base_zona$POBTOT)), digits = 3) %>% percent()``
- Porcentaje de población de 15 años y más con educación básica completa: ``r round(sum(Base_zona$P15SEC_CO) / sum(Base_zona$POBTOT), digits = 3) %>% percent()`` 
- Porcentaje de población de 15 años y más con secundaria o equivalente incompleta:``r round(sum(Base_zona$P15SEC_IN) / sum(Base_zona$POBTOT), digits = 3) %>% percent()`` 
- Porcentaje de población de 18 años y más ocupada con al menos un grado aprobado en educación media superior: ``r round(sum(Base_zona$P18YM_PB) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``

#### Salud

En el Censo del año 2020, se manifiesta que la situación de la afiliación es la siguiente:

- Porcentaje de población afiliada a servicios de salud: ``r round(sum(Base_zona$PDER_SS) / sum(Base_zona$POBTOT), digits = 3) %>% percent()``
- Población sin afiliación a servicios de salud:``r format(sum(Base_zona$PSINDER), scientific = FALSE, digits = 3)`` 

### Datos económicos.
#### *Variables económicas*

```{r}
library(shiny)
library(DT)
library(data.table)

# UI
ui <- fluidPage(
  
  # Selección del año
  selectInput("year", "Selecciona el año:",
              choices = c("1999", "2004", "2009", "2014", "2019"),
              selected = "1999"),
  
  # Tablas
  tabsetPanel(
    tabPanel("UE", dataTableOutput("table_ue")),
    tabPanel("AF", dataTableOutput("table_af")),
    tabPanel("FB", dataTableOutput("table_fb")),
    tabPanel("PB", dataTableOutput("table_pb")),
    tabPanel("PO", dataTableOutput("table_po")),
    tabPanel("RE", dataTableOutput("table_re")),
    tabPanel("VA", dataTableOutput("table_va"))
  )
)

server <- function(input, output) {
  
  # Filtrar variables según el año seleccionado
  
  vars_ue.99 <- c("ue.pri_99", "ue.con_99", "ue.man_99", "ue.com_99", "ue.ser_99")
  vars_ue.04 <- c("ue.pri_04", "ue.con_04", "ue.man_04", "ue.com_04", "ue.ser_04")
  vars_ue.09 <- c("ue.pri_09", "ue.con_09", "ue.man_09", "ue.com_09", "ue.ser_09")
  vars_ue.14 <- c("ue.pri_14", "ue.con_14", "ue.man_14", "ue.com_14", "ue.ser_14")
  vars_ue.19 <- c("ue.pri_19", "ue.con_19", "ue.man_19", "ue.com_19", "ue.ser_19")
   
  vars_af.99 <- c("af.pri_99", "af.con_99", "af.man_99", "af.com_99", "af.ser_99")
  vars_af.04 <- c("af.pri_04", "af.con_04", "af.man_04", "af.com_04", "af.ser_04")
  vars_af.09 <- c("af.pri_09", "af.con_09", "af.man_09", "af.com_09", "af.ser_09")
  vars_af.14 <- c("af.pri_14", "af.con_14", "af.man_14", "af.com_14", "af.ser_14")
  vars_af.19 <- c("af.pri_19", "af.con_19", "af.man_19", "af.com_19", "af.ser_19")

  vars_fb.99 <- c("fb.pri_99", "fb.con_99", "fb.man_99", "fb.com_99", "fb.ser_99")
  vars_fb.04 <- c("fb.pri_04", "fb.con_04", "fb.man_04", "fb.com_04", "fb.ser_04")
  vars_fb.09 <- c("fb.pri_09", "fb.con_09", "fb.man_09", "fb.com_09", "fb.ser_09")
  vars_fb.14 <- c("fb.pri_14", "fb.con_14", "fb.man_14", "fb.com_14", "fb.ser_14")
  vars_fb.19 <- c("fb.pri_19", "fb.con_19", "fb.man_19", "fb.com_19", "fb.ser_19")

  vars_pb.99 <- c("pb.pri_99", "pb.con_99", "pb.man_99", "pb.com_99", "pb.ser_99")
  vars_pb.04 <- c("pb.pri_04", "pb.con_04", "pb.man_04", "pb.com_04", "pb.ser_04")
  vars_pb.09 <- c("pb.pri_09", "pb.con_09", "pb.man_09", "pb.com_09", "pb.ser_09")
  vars_pb.14 <- c("pb.pri_14", "pb.con_14", "pb.man_14", "pb.com_14", "pb.ser_14")
  vars_pb.19 <- c("pb.pri_19", "pb.con_19", "pb.man_19", "pb.com_19", "pb.ser_19")
  
  vars_po.99 <- c("po.pri_99", "po.con_99", "po.man_99", "po.com_99", "po.ser_99")
  vars_po.04 <- c("po.pri_04", "po.con_04", "po.man_04", "po.com_04", "po.ser_04")
  vars_po.09 <- c("po.pri_09", "po.con_09", "po.man_09", "po.com_09", "po.ser_09")
  vars_po.14 <- c("po.pri_14", "po.con_14", "po.man_14", "po.com_14", "po.ser_14")
  vars_po.19 <- c("po.pri_19", "po.con_19", "po.man_19", "po.com_19", "po.ser_19")

  vars_re.99 <- c("re.pri_99", "re.con_99", "re.man_99", "re.com_99", "re.ser_99")
  vars_re.04 <- c("re.pri_04", "re.con_04", "re.man_04", "re.com_04", "re.ser_04")
  vars_re.09 <- c("re.pri_09", "re.con_09", "re.man_09", "re.com_09", "re.ser_09")
  vars_re.14 <- c("re.pri_14", "re.con_14", "re.man_14", "re.com_14", "re.ser_14")
  vars_re.19 <- c("re.pri_19", "re.con_19", "re.man_19", "re.com_19", "re.ser_19")

  vars_va.99 <- c("va.pri_99", "va.con_99", "va.man_99", "va.com_99", "va.ser_99")
  vars_va.04 <- c("va.pri_04", "va.con_04", "va.man_04", "va.com_04", "va.ser_04")
  vars_va.09 <- c("va.pri_09", "va.con_09", "va.man_09", "va.com_09", "va.ser_09")
  vars_va.14 <- c("va.pri_14", "va.con_14", "va.man_14", "va.com_14", "va.ser_14")
  vars_va.19 <- c("va.pri_19", "va.con_19", "va.man_19", "va.com_19", "va.ser_19")

  # Obtener los datos de la base según el año y variables seleccionadas
  
  filtered_data_ue <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_ue.99,
                                                 "2004" = vars_ue.04,
                                                 "2009" = vars_ue.09,
                                                 "2014" = vars_ue.14,
                                                 "2019" = vars_ue.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_af <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_af.99,
                                                 "2004" = vars_af.04,
                                                 "2009" = vars_af.09,
                                                 "2014" = vars_af.14,
                                                 "2019" = vars_af.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_fb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_fb.99,
                                                 "2004" = vars_fb.04,
                                                 "2009" = vars_fb.09,
                                                 "2014" = vars_fb.14,
                                                 "2019" = vars_fb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_pb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_pb.99,
                                                 "2004" = vars_pb.04,
                                                 "2009" = vars_pb.09,
                                                 "2014" = vars_pb.14,
                                                 "2019" = vars_pb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_po <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_po.99,
                                                 "2004" = vars_po.04,
                                                 "2009" = vars_po.09,
                                                 "2014" = vars_po.14,
                                                 "2019" = vars_po.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_re <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_re.99,
                                                 "2004" = vars_re.04,
                                                 "2009" = vars_re.09,
                                                 "2014" = vars_re.14,
                                                 "2019" = vars_re.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_va <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_va.99,
                                                 "2004" = vars_va.04,
                                                 "2009" = vars_va.09,
                                                 "2014" = vars_va.14,
                                                 "2019" = vars_va.19))
    subset(Base_zona, select = select_cols)
  })
  
# Cambiar nombres de columnas
  
output$table_ue <- renderDataTable({
  data <- filtered_data_ue()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Unidades económicas",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_af <- renderDataTable({
  data <- filtered_data_af()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Activiso fijos totales (miles de pesos)",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_fb <- renderDataTable({
  data <- filtered_data_fb()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Formación bruta de capital fijo (miles de pesos)",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
output$table_pb <- renderDataTable({
  data <- filtered_data_pb()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Producción bruta total (miles de pesos)",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_po <- renderDataTable({
  data <- filtered_data_po()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Personal ocupado total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_re <- renderDataTable({
  data <- filtered_data_re()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Remueraciones totales (miles de pesos)",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
  output$table_va <- renderDataTable({
  data <- filtered_data_va()
  data[] <- lapply(data, function(x) format(x, big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Valor agregado censal bruto (miles de pesos)",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
}

# Ejecutar la aplicación
shinyApp(ui = ui, server = server)
```
#### *Coeficientes de Localización Económica (QL)*

```{r}

# UI
ui <- fluidPage(
  
  # Selección del año
  selectInput("year", "Selecciona el año:",
              choices = c("1999", "2004", "2009", "2014", "2019"),
              selected = "1999"),
  
  # Tablas
  tabsetPanel(
    tabPanel("UE", dataTableOutput("table_QLue")),
    tabPanel("AF", dataTableOutput("table_QLaf")),
    tabPanel("FB", dataTableOutput("table_QLfb")),
    tabPanel("PB", dataTableOutput("table_QLpb")),
    tabPanel("PO", dataTableOutput("table_QLpo")),
    tabPanel("RE", dataTableOutput("table_QLre")),
    tabPanel("VA", dataTableOutput("table_QLva"))
  )
)

server <- function(input, output) {
  
  # Filtrar variables según el año seleccionado
  
 vars_QLue.99 <- paste0("QLue.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLue.04 <- paste0("QLue.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLue.09 <- paste0("QLue.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLue.14 <- paste0("QLue.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLue.19 <- paste0("QLue.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
   
 vars_QLaf.99 <- paste0("QLaf.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLaf.04 <- paste0("QLaf.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLaf.09 <- paste0("QLaf.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLaf.14 <- paste0("QLaf.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLaf.19 <- paste0("QLaf.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_QLfb.99 <- paste0("QLfb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLfb.04 <- paste0("QLfb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLfb.09 <- paste0("QLfb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLfb.14 <- paste0("QLfb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLfb.19 <- paste0("QLfb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_QLpb.99 <- paste0("QLpb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLpb.04 <- paste0("QLpb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLpb.09 <- paste0("QLpb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLpb.14 <- paste0("QLpb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLpb.19 <- paste0("QLpb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_QLpo.99 <- paste0("QLpo.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLpo.04 <- paste0("QLpo.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLpo.09 <- paste0("QLpo.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLpo.14 <- paste0("QLpo.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLpo.19 <- paste0("QLpo.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_QLre.99 <- paste0("QLre.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLre.04 <- paste0("QLre.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLre.09 <- paste0("QLre.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLre.14 <- paste0("QLre.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLre.19 <- paste0("QLre.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_QLva.99 <- paste0("QLva.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_QLva.04 <- paste0("QLva.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_QLva.09 <- paste0("QLva.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_QLva.14 <- paste0("QLva.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_QLva.19 <- paste0("QLva.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

  # Obtener los datos de la base según el año y variables seleccionadas
  
  filtered_data_QLue <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLue.99,
                                                 "2004" = vars_QLue.04,
                                                 "2009" = vars_QLue.09,
                                                 "2014" = vars_QLue.14,
                                                 "2019" = vars_QLue.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLaf <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLaf.99,
                                                 "2004" = vars_QLaf.04,
                                                 "2009" = vars_QLaf.09,
                                                 "2014" = vars_QLaf.14,
                                                 "2019" = vars_QLaf.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLfb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLfb.99,
                                                 "2004" = vars_QLfb.04,
                                                 "2009" = vars_QLfb.09,
                                                 "2014" = vars_QLfb.14,
                                                 "2019" = vars_QLfb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLpb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLpb.99,
                                                 "2004" = vars_QLpb.04,
                                                 "2009" = vars_QLpb.09,
                                                 "2014" = vars_QLpb.14,
                                                 "2019" = vars_QLpb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLpo <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLpo.99,
                                                 "2004" = vars_QLpo.04,
                                                 "2009" = vars_QLpo.09,
                                                 "2014" = vars_QLpo.14,
                                                 "2019" = vars_QLpo.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLre <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLre.99,
                                                 "2004" = vars_QLre.04,
                                                 "2009" = vars_QLre.09,
                                                 "2014" = vars_QLre.14,
                                                 "2019" = vars_QLre.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_QLva <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_QLva.99,
                                                 "2004" = vars_QLva.04,
                                                 "2009" = vars_QLva.09,
                                                 "2014" = vars_QLva.14,
                                                 "2019" = vars_QLva.19))
    subset(Base_zona, select = select_cols)
  })
  
# Cambiar nombres de columnas
  
output$table_QLue <- renderDataTable({
  data <- filtered_data_QLue()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Unidades económicas",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")


output$table_QLfb <- renderDataTable({
  data <- filtered_data_QLfb()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Formación bruta de capital fijo",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_QLpb <- renderDataTable({
  data <- filtered_data_QLpb()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Producción bruta total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

  
output$table_QLpb <- renderDataTable({
  data <- filtered_data_QLpb()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Producción bruta total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_QLpo <- renderDataTable({
  data <- filtered_data_QLpo()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Personal ocupado total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_QLre <- renderDataTable({
  data <- filtered_data_QLre()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Remueraciones totales",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
 output$table_QLva <- renderDataTable({
  data <- filtered_data_QLva()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Valor agregado censal bruto",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
}

# Ejecutar la aplicación
shinyApp(ui = ui, server = server)
```

#### *Coeficientes de Participación Relativa (PR)*

```{r}

# UI
ui <- fluidPage(
  
  # Selección del año
  selectInput("year", "Selecciona el año:",
              choices = c("1999", "2004", "2009", "2014", "2019"),
              selected = "1999"),
  
  # Tablas
  tabsetPanel(
    tabPanel("UE", dataTableOutput("table_PRue")),
    tabPanel("AF", dataTableOutput("table_PRaf")),
    tabPanel("FB", dataTableOutput("table_PRfb")),
    tabPanel("PB", dataTableOutput("table_PRpb")),
    tabPanel("PO", dataTableOutput("table_PRpo")),
    tabPanel("RE", dataTableOutput("table_PRre")),
    tabPanel("VA", dataTableOutput("table_PRva"))
  )
)

server <- function(input, output) {
  
  # Filtrar variables según el año seleccionado
  
 vars_PRue.99 <- paste0("PRue.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRue.04 <- paste0("PRue.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRue.09 <- paste0("PRue.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRue.14 <- paste0("PRue.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRue.19 <- paste0("PRue.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
   
 vars_PRaf.99 <- paste0("PRaf.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRaf.04 <- paste0("PRaf.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRaf.09 <- paste0("PRaf.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRaf.14 <- paste0("PRaf.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRaf.19 <- paste0("PRaf.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_PRfb.99 <- paste0("PRfb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRfb.04 <- paste0("PRfb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRfb.09 <- paste0("PRfb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRfb.14 <- paste0("PRfb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRfb.19 <- paste0("PRfb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_PRpb.99 <- paste0("PRpb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRpb.04 <- paste0("PRpb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRpb.09 <- paste0("PRpb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRpb.14 <- paste0("PRpb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRpb.19 <- paste0("PRpb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_PRpo.99 <- paste0("PRpo.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRpo.04 <- paste0("PRpo.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRpo.09 <- paste0("PRpo.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRpo.14 <- paste0("PRpo.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRpo.19 <- paste0("PRpo.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_PRre.99 <- paste0("PRre.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRre.04 <- paste0("PRre.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRre.09 <- paste0("PRre.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRre.14 <- paste0("PRre.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRre.19 <- paste0("PRre.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_PRva.99 <- paste0("PRva.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_PRva.04 <- paste0("PRva.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_PRva.09 <- paste0("PRva.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_PRva.14 <- paste0("PRva.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_PRva.19 <- paste0("PRva.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

  # Obtener los datos de la base según el año y variables seleccionadas
  
  filtered_data_PRue <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRue.99,
                                                 "2004" = vars_PRue.04,
                                                 "2009" = vars_PRue.09,
                                                 "2014" = vars_PRue.14,
                                                 "2019" = vars_PRue.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRaf <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRaf.99,
                                                 "2004" = vars_PRaf.04,
                                                 "2009" = vars_PRaf.09,
                                                 "2014" = vars_PRaf.14,
                                                 "2019" = vars_PRaf.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRfb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRfb.99,
                                                 "2004" = vars_PRfb.04,
                                                 "2009" = vars_PRfb.09,
                                                 "2014" = vars_PRfb.14,
                                                 "2019" = vars_PRfb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRpb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRpb.99,
                                                 "2004" = vars_PRpb.04,
                                                 "2009" = vars_PRpb.09,
                                                 "2014" = vars_PRpb.14,
                                                 "2019" = vars_PRpb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRpo <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRpo.99,
                                                 "2004" = vars_PRpo.04,
                                                 "2009" = vars_PRpo.09,
                                                 "2014" = vars_PRpo.14,
                                                 "2019" = vars_PRpo.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRre <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRre.99,
                                                 "2004" = vars_PRre.04,
                                                 "2009" = vars_PRre.09,
                                                 "2014" = vars_PRre.14,
                                                 "2019" = vars_PRre.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_PRva <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_PRva.99,
                                                 "2004" = vars_PRva.04,
                                                 "2009" = vars_PRva.09,
                                                 "2014" = vars_PRva.14,
                                                 "2019" = vars_PRva.19))
    subset(Base_zona, select = select_cols)
  })
  
# Cambiar nombres de columnas
  
output$table_PRue <- renderDataTable({
  data <- filtered_data_PRue()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Unidades económicas",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")


output$table_PRaf <- renderDataTable({
  data <- filtered_data_PRaf()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Activiso fijos totales",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_PRfb <- renderDataTable({
  data <- filtered_data_PRfb()
  data[] <- lapply(data, function(x) format(round(as.numeric(x), 3), big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Formación bruta de capital fijo",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
output$table_PRpb <- renderDataTable({
  data <- filtered_data_PRpb()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Producción bruta total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_PRpo <- renderDataTable({
  data <- filtered_data_PRpo()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Personal ocupado total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_PRre <- renderDataTable({
  data <- filtered_data_PRre()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Remueraciones totales",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
 output$table_PRva <- renderDataTable({
  data <- filtered_data_PRva()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Valor agregado censal bruto",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
}

# Ejecutar la aplicación
shinyApp(ui = ui, server = server)
```


#### *Coeficientes Hirschman-Herfindahl (HH)*

```{r}

# UI
ui <- fluidPage(
  
  # Selección del año
  selectInput("year", "Selecciona el año:",
              choices = c("1999", "2004", "2009", "2014", "2019"),
              selected = "1999"),
  
  # Tablas
  tabsetPanel(
    tabPanel("UE", dataTableOutput("table_HHue")),
    tabPanel("AF", dataTableOutput("table_HHaf")),
    tabPanel("FB", dataTableOutput("table_HHfb")),
    tabPanel("PB", dataTableOutput("table_HHpb")),
    tabPanel("PO", dataTableOutput("table_HHpo")),
    tabPanel("RE", dataTableOutput("table_HHre")),
    tabPanel("VA", dataTableOutput("table_HHva"))
  )
)

server <- function(input, output) {
  
  # Filtrar variables según el año seleccionado
  
 vars_HHue.99 <- paste0("HHue.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHue.04 <- paste0("HHue.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHue.09 <- paste0("HHue.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHue.14 <- paste0("HHue.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHue.19 <- paste0("HHue.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
   
 vars_HHaf.99 <- paste0("HHaf.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHaf.04 <- paste0("HHaf.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHaf.09 <- paste0("HHaf.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHaf.14 <- paste0("HHaf.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHaf.19 <- paste0("HHaf.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_HHfb.99 <- paste0("HHfb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHfb.04 <- paste0("HHfb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHfb.09 <- paste0("HHfb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHfb.14 <- paste0("HHfb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHfb.19 <- paste0("HHfb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_HHpb.99 <- paste0("HHpb.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHpb.04 <- paste0("HHpb.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHpb.09 <- paste0("HHpb.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHpb.14 <- paste0("HHpb.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHpb.19 <- paste0("HHpb.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_HHpo.99 <- paste0("HHpo.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHpo.04 <- paste0("HHpo.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHpo.09 <- paste0("HHpo.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHpo.14 <- paste0("HHpo.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHpo.19 <- paste0("HHpo.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

 vars_HHre.99 <- paste0("HHre.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHre.04 <- paste0("HHre.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHre.09 <- paste0("HHre.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHre.14 <- paste0("HHre.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHre.19 <- paste0("HHre.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))
 
 vars_HHva.99 <- paste0("HHva.", c("pri_99", "con_99", "man_99", "com_99", "ser_99"))
 vars_HHva.04 <- paste0("HHva.", c("pri_04", "con_04", "man_04", "com_04", "ser_04"))
 vars_HHva.09 <- paste0("HHva.", c("pri_09", "con_09", "man_09", "com_09", "ser_09"))
 vars_HHva.14 <- paste0("HHva.", c("pri_14", "con_14", "man_14", "com_14", "ser_14"))
 vars_HHva.19 <- paste0("HHva.", c("pri_19", "con_19", "man_19", "com_19", "ser_19"))

  # Obtener los datos de la base según el año y variables seleccionadas
  
  filtered_data_HHue <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHue.99,
                                                 "2004" = vars_HHue.04,
                                                 "2009" = vars_HHue.09,
                                                 "2014" = vars_HHue.14,
                                                 "2019" = vars_HHue.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHaf <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHaf.99,
                                                 "2004" = vars_HHaf.04,
                                                 "2009" = vars_HHaf.09,
                                                 "2014" = vars_HHaf.14,
                                                 "2019" = vars_HHaf.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHfb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHfb.99,
                                                 "2004" = vars_HHfb.04,
                                                 "2009" = vars_HHfb.09,
                                                 "2014" = vars_HHfb.14,
                                                 "2019" = vars_HHfb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHpb <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHpb.99,
                                                 "2004" = vars_HHpb.04,
                                                 "2009" = vars_HHpb.09,
                                                 "2014" = vars_HHpb.14,
                                                 "2019" = vars_HHpb.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHpo <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHpo.99,
                                                 "2004" = vars_HHpo.04,
                                                 "2009" = vars_HHpo.09,
                                                 "2014" = vars_HHpo.14,
                                                 "2019" = vars_HHpo.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHre <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHre.99,
                                                 "2004" = vars_HHre.04,
                                                 "2009" = vars_HHre.09,
                                                 "2014" = vars_HHre.14,
                                                 "2019" = vars_HHre.19))
    subset(Base_zona, select = select_cols)
  })
  
  filtered_data_HHva <- reactive({
    select_cols <- c("nom_mun", "cvegeo", switch(input$year,
                                                 "1999" = vars_HHva.99,
                                                 "2004" = vars_HHva.04,
                                                 "2009" = vars_HHva.09,
                                                 "2014" = vars_HHva.14,
                                                 "2019" = vars_HHva.19))
    subset(Base_zona, select = select_cols)
  })
  
# Cambiar nombres de columnas
  
output$table_HHue <- renderDataTable({
  data <- filtered_data_HHue()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Unidades económicas",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")


output$table_HHaf <- renderDataTable({
  data <- filtered_data_HHaf()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Activiso fijos totales",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_HHfb <- renderDataTable({
  data <- filtered_data_HHfb()
  data[] <- lapply(data, function(x) format(round(as.numeric(x), 3), big.mark = ","))
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Formación bruta de capital fijo",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
output$table_HHpb <- renderDataTable({
  data <- filtered_data_HHpb()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Producción bruta total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_HHpo <- renderDataTable({
  data <- filtered_data_HHpo()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Personal ocupado total",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")

output$table_HHre <- renderDataTable({
  data <- filtered_data_HHre()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Remueraciones totales",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
 output$table_HHva <- renderDataTable({
  data <- filtered_data_HHva()
  data[] <- lapply(data, function(x) {
    if(is.numeric(x)) {
      format(round(as.numeric(x), 3), big.mark = ",")
    } else {
      x
    }
  })
  setNames(data, c("Nombre", "Clave", "Primario", "Construcción", "Manufactura", "Comercio", "Servicios"))
},
caption = "Valor agregado censal bruto",
options = list(pageLength = 10, lengthChange = FALSE, scrollX = TRUE, searching = FALSE),
rownames = FALSE,
width = "40%")
  
}

# Ejecutar la aplicación
shinyApp(ui = ui, server = server)
```
